"use strict";const canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),btnStart=document.getElementById("start"),btnRestart=document.getElementById("restart"),fx=new Audio("audio/collision.mp3"),bgm=new Audio("audio/bgm.mp3");var images={},backgrounds=[],car={},enemies=[],score=0,enemiesSprite=[0,262,547];function loadImage(e){return new Promise((t,s)=>{let a=new Image;a.onload=()=>t(a),a.onerror=e=>{alert("Lỗi!\nTải c\xe1c file cần thiết thất bại."),s(e)},a.src=e})}class Game{constructor(e,t,s,a,i){this.context=canvas.getContext("2d"),this.image=e,this.dx=t,this.dy=s,this.width=a,this.height=i,this._moveLeft=!1,this._moveRight=!1,this.speedX=8,this.speedY=10,this.state="PAUSED"}moveLeft(){this._moveLeft=!0}moveRight(){this._moveRight=!0}render(){this.context.drawImage(this.image,this.dx,this.dy,this.width,this.height)}update(){this._moveRight?this.dx+=this.speedX:this._moveLeft&&(this.dx-=this.speedX),this.dx<30&&(this.dx=30),this.dx>canvas.width-(this.width+33)&&(this.dx=canvas.width-(this.width+33))}}class Background extends Game{constructor(e,t,s,a,i){super(e,t,s,a,i)}update(){this.dy+=car.speedY,0===this.dy?(backgrounds.splice(0,1),backgrounds.push(new Background(images.background,0,-images.background.height,canvas.width,canvas.height))):this.dy>0&&this.dy<this.speedY&&(backgrounds.splice(0,1),backgrounds.push(new Background(images.background,0,-images.background.height+this.dy,canvas.width,canvas.height)))}}class Enemy extends Game{constructor(e,t,s,a,i,n,r,h,d){super(e,n,r,h,d),this.sx=t,this.sy=s,this.swidth=a,this.sheight=i,this.speed=2}render(){this.context.drawImage(this.image,this.sx,this.sy,this.swidth,this.sheight,this.dx,this.dy,this.width,this.height)}update(){this.dy+=this.speed+this.speedY,this.dy>=canvas.height&&(score+=10,enemies.splice(enemies.indexOf(this),1))}}function randomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}const responseEnemies=(()=>{var e=0;return function(){if(120==++e){let t=enemiesSprite[randomInt(0,enemiesSprite.length-1)],s=randomInt(0,1)?30:168,a=randomInt(263,406);enemies.push(new Enemy(images.enemies,4,t,118,240,s,-a,100,203)),e=0}}})();function detectCollision(){let e=!1,t=!1;for(let s=0;s<enemies.length;s++){if(car.dx+car.width-1>enemies[s].dx&&car.dx+2<enemies[s].dx+enemies[s].width&&(e=!0),car.dy<=enemies[s].dy+enemies[s].height&&car.dy+car.height>=enemies[s].dy&&(t=!0),e&&t)return!0;return!1}}function startGame(){btnStart.style="display: none",btnRestart.style="display: none",bgm.loop=!0,bgm.play(),backgrounds.push(new Background(images.background,0,0,canvas.width,canvas.height)),backgrounds.push(new Background(images.background,0,-canvas.height,canvas.width,canvas.height)),(car=new Game(images.car,30,canvas.height-250,100,200)).status="RUNNING",updateGame()}function restartGame(){backgrounds=[],car={},enemies=[],score=0,startGame()}function updateGame(){ctx.clearRect(0,0,canvas.width,canvas.height);for(let e=0;e<backgrounds.length;e++)backgrounds[e].render();for(let t=0;t<enemies.length;t++)enemies[t].render();if(car.render(),ctx.font="20px Comic Sans MS",ctx.fillStyle="red",ctx.fillText("Điểm: "+score,10,30),detectCollision()){btnRestart.style="display: block",bgm.pause(),bgm.currentTime=0,fx.currentTime=0,fx.play(),car.status="PAUSED";return}for(let s=0;s<backgrounds.length;s++)backgrounds[s].update();for(let a=0;a<enemies.length;a++)enemies[a].update();car.update(),responseEnemies(),window.requestAnimationFrame(updateGame)}window.addEventListener("keydown",e=>{switch(e.keyCode||e.which){case 37:car.moveLeft();break;case 38:console.log("Up");break;case 39:car.moveRight();break;case 40:console.log("Down")}}),window.addEventListener("keyup",e=>{switch(e.keyCode||e.which){case 37:car._moveLeft=!1;break;case 38:car._speedUp=!1;break;case 39:car._moveRight=!1;break;case 40:console.log("Down")}}),window.addEventListener("keyup",e=>{(13===e.keyCode||13===e.which)&&"RUNNING"!==car.status&&restartGame()}),loadImage("./images/background.png").then(e=>{images.background=e,loadImage("./images/car.png").then(e=>{images.car=e,loadImage("./images/enemies.png").then(e=>{images.enemies=e,btnStart.style="display: block"})})});